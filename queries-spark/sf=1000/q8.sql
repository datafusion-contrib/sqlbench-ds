-- SQLBench-DS query 8 derived from TPC-DS query 8 under the terms of the TPC Fair Use Policy.
-- TPC-DS queries are Copyright 2021 Transaction Processing Performance Council.
-- This query was generated at scale factor 1000.
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '62099','24644','76757','49193','20642','86581',
                          '16911','39485','11153','13468','49512',
                          '14704','71964','14232','39580','67089',
                          '67976','23717','86503','13544','24413',
                          '24577','44244','77768','63938','19511',
                          '12511','66179','35031','13937','92462',
                          '87176','14972','30770','64826','84862',
                          '14880','39901','51052','28512','49768',
                          '47819','53712','73579','89975','34945',
                          '47681','62766','22222','56892','10378',
                          '15653','50051','26209','36507','92302',
                          '56664','79557','52253','99918','85234',
                          '23002','55373','87833','34861','50116',
                          '66139','31582','37623','26902','45368',
                          '75780','71536','65511','20369','42075',
                          '17815','34043','40626','24099','30373',
                          '74925','25384','63255','11637','51521',
                          '61493','60525','38874','16041','28938',
                          '10415','15492','93616','19707','87784',
                          '60272','26914','83241','79065','71647',
                          '77110','44127','15944','80619','60609',
                          '82290','69710','77685','60347','27087',
                          '96370','18658','76196','29702','63432',
                          '63205','79104','86643','55836','69978',
                          '22480','21608','48257','87243','53657',
                          '97127','92877','47977','35050','85788',
                          '96826','45485','13208','96049','49436',
                          '12015','55113','48375','40340','62275',
                          '36883','69960','71609','22960','41184',
                          '43637','86614','44689','38072','26376',
                          '72299','27446','21317','52509','30426',
                          '66624','87490','15656','59804','22641',
                          '27215','92734','79002','43095','89090',
                          '60784','36763','16171','73220','98433',
                          '50099','46690','53827','99874','29655',
                          '75550','78445','35313','80286','50001',
                          '25832','41255','12357','64770','24542',
                          '40806','91171','32174','58943','19301',
                          '61145','29449','26701','60996','23558',
                          '74552','19966','22743','13076','68739',
                          '15872','63532','90169','72084','83439',
                          '51797','32974','26396','63458','87088',
                          '85709','67653','57556','27289','19650',
                          '70494','52058','56463','99880','60144',
                          '24485','34913','14281','90662','55267',
                          '58361','54315','22131','56909','87120',
                          '42357','92574','37094','45041','79548',
                          '88123','25885','78086','62806','25651',
                          '31105','10019','12756','87912','46964',
                          '36857','67704','18294','68277','12105',
                          '92779','13255','28809','69969','22768',
                          '71094','43547','45056','32640','91525',
                          '25995','93717','60528','89243','95731',
                          '11164','31381','79785','27064','34564',
                          '64757','26351','71936','82676','98049',
                          '22169','85971','89737','65323','88802',
                          '65063','54779','45911','94341','42137',
                          '34159','21784','28941','16281','44824',
                          '11114','42956','18064','78131','95167',
                          '25493','91035','53501','68155','38491',
                          '94727','20001','42098','49090','80812',
                          '84362','46383','67985','58815','44112',
                          '72311','88003','67325','63681','55828',
                          '99356','33434','19572','78046','17494',
                          '24457','81653','78811','87219','15289',
                          '86724','82602','59513','95348','78325',
                          '17197','57595','72257','43560','54144',
                          '61568','85997','13842','27204','69011',
                          '23360','40043','44701','67304','68704',
                          '56806','27873','25610','20324','46212',
                          '64662','63716','97531','25017','29851',
                          '46716','26338','87897','45848','14971',
                          '23642','21644','81460','48866','58767',
                          '68257','16261','11884','45965','92815',
                          '66324','39653','64600','97420','14546',
                          '59031','48503','99719','65245','13289',
                          '80178','12702','67538','10623','72489',
                          '67146','36415','30082','20973','20406',
                          '22738','34670','19948','20590','38279',
                          '53820','49086','63058','98071')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
  LIMIT 100;

